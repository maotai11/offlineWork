<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¢ç·šå·¥ä½œç®¡ç†ç³»çµ± Phase 4</title>

    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent: #4a90e2;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #242424;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .user-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-switcher select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
        }

        .btn-new-user {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .dark-mode-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }

        .filter-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .search-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .search-bar input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-options select,
        .filter-options button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .bulk-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-select-all {
            background: var(--accent);
            color: white;
        }

        .btn-bulk-complete {
            background: var(--success);
            color: white;
        }

        .btn-bulk-delete {
            background: var(--danger);
            color: white;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .todo-item {
            background: var(--bg-card);
            padding: 18px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .todo-item:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .todo-item.pinned {
            border-left: 4px solid var(--accent);
            background: linear-gradient(90deg, rgba(74, 144, 226, 0.1), var(--bg-card));
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }

        .pin-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .pin-btn:hover,
        .pin-btn.active {
            opacity: 1;
            transform: scale(1.2);
        }

        .todo-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .category-tag {
            display: inline-block;
            padding: 4px 10px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .priority-high { color: var(--danger); font-weight: bold; }
        .priority-medium { color: var(--warning); }
        .priority-low { color: var(--text-secondary); }

        .status-todo { color: var(--text-secondary); }
        .status-in-progress { color: var(--accent); }
        .status-completed { color: var(--success); }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .export-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn-export, .btn-import {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-export {
            background: var(--accent);
            color: white;
        }

        .btn-import {
            background: var(--success);
            color: white;
        }

        .add-form {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-grid input,
        .form-grid select,
        .form-grid textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-grid textarea {
            grid-column: 1 / -1;
            resize: vertical;
            min-height: 80px;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 10000;
            min-width: 300px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .confirm-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-confirm-yes {
            background: var(--danger);
            color: white;
        }

        .btn-confirm-no {
            background: var(--text-secondary);
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="user-switcher">
                <span>ç”¨æˆ¶:</span>
                <select id="userSelect" onchange="app.switchUser(this.value)">
                    <option value="default">é è¨­ç”¨æˆ¶</option>
                </select>
                <button class="btn-new-user" onclick="app.addNewUser()">+ æ–°ç”¨æˆ¶</button>
            </div>

            <button class="dark-mode-toggle" onclick="app.toggleDarkMode()" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ç¸½ä»»å‹™æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="inProgressCount">0</div>
                <div class="stat-label">é€²è¡Œä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">å®Œæˆç‡</div>
            </div>
        </div>

        <div class="filter-section">
            <div class="search-bar">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="æœå°‹ä»»å‹™... (Ctrl+F)" 
                    oninput="app.filterTodos()"
                >
            </div>
            <div class="filter-options">
                <select id="filterStatus" onchange="app.filterTodos()">
                    <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                    <option value="todo">å¾…è¾¦</option>
                    <option value="in-progress">é€²è¡Œä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                </select>
                <select id="filterPriority" onchange="app.filterTodos()">
                    <option value="all">æ‰€æœ‰å„ªå…ˆåº¦</option>
                    <option value="high">é«˜</option>
                    <option value="medium">ä¸­</option>
                    <option value="low">ä½</option>
                </select>
                <select id="filterCategory" onchange="app.filterTodos()">
                    <option value="all">æ‰€æœ‰åˆ†é¡</option>
                </select>
                <button onclick="app.clearFilters()">æ¸…é™¤ç¯©é¸</button>
            </div>
        </div>

        <div class="bulk-actions">
            <button class="btn-select-all" onclick="app.toggleSelectAll()">
                <span id="selectAllText">å…¨é¸</span>
            </button>
            <button class="btn-bulk-complete" onclick="app.bulkComplete()">æ‰¹é‡å®Œæˆ</button>
            <button class="btn-bulk-delete" onclick="app.bulkDelete()">æ‰¹é‡åˆªé™¤</button>
            <span id="selectedCount" style="margin-left: auto; color: var(--text-secondary);"></span>
        </div>

        <div class="export-section">
            <button class="btn-export" onclick="app.exportData('json')">ğŸ“¥ JSON</button>
            <button class="btn-export" onclick="app.exportData('csv')">ğŸ“Š CSV</button>
            <button class="btn-export" onclick="app.exportData('excel')">ğŸ“— Excel</button>
            <button class="btn-export" onclick="app.exportData('markdown')">ğŸ“ Markdown</button>
            <button class="btn-export" onclick="app.exportAllUsers()">ğŸ“¦ ç¸½è¦½åŒ¯å‡º</button>
            <button class="btn-import" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="app.importData(event)">
        </div>

        <div class="add-form">
            <div class="form-grid">
                <input type="text" id="todoTitle" placeholder="ä»»å‹™æ¨™é¡Œ" />
                <input type="text" id="todoCategory" placeholder="åˆ†é¡ (å·¥ä½œ/å€‹äºº/å­¸ç¿’)" />
                <select id="todoPriority">
                    <option value="medium">å„ªå…ˆåº¦: ä¸­</option>
                    <option value="high">å„ªå…ˆåº¦: é«˜</option>
                    <option value="low">å„ªå…ˆåº¦: ä½</option>
                </select>
                <select id="todoStatus">
                    <option value="todo">å¾…è¾¦</option>
                    <option value="in-progress">é€²è¡Œä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                </select>
                <input type="date" id="todoDueDate" />
                <input type="number" id="todoProgress" placeholder="é€²åº¦ (%)" min="0" max="100" />
                <input type="text" id="todoTags" placeholder="æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)" />
                <textarea id="todoDescription" placeholder="æè¿°"></textarea>
            </div>
            <button class="btn-add" onclick="app.addTodo()">+ æ–°å¢ä»»å‹™</button>
        </div>

        <div class="todo-list" id="todoList"></div>
    </div>

    <script>
// ==================== Phase 4: å®Œæ•´ JavaScript ====================
// åŠŸèƒ½: æœå°‹/ç¯©é¸ã€æ‰¹é‡æ“ä½œã€é‡˜é¸ã€åˆ†é¡ã€å¤šç”¨æˆ¶ã€XSSé˜²è­·ã€UXå¼·åŒ–

(function() {
    'use strict';

    // ==================== XSS é˜²è­·å·¥å…· ====================
    const Security = {
        // HTML escape é˜²æ­¢ XSS
        escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },

        // æ¸…ç† URLï¼ˆé˜²æ­¢ javascript: å”è­°ï¼‰
        sanitizeURL(url) {
            if (!url) return '';
            const lower = url.toLowerCase().trim();
            if (lower.startsWith('javascript:') || 
                lower.startsWith('data:') || 
                lower.startsWith('vbscript:')) {
                return '';
            }
            return url;
        },

        // é©—è­‰æ—¥æœŸæ ¼å¼
        validateDate(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : dateStr;
        },

        // é©—è­‰æ•¸å­—ç¯„åœ
        validateNumber(num, min = 0, max = 100) {
            const n = parseInt(num, 10);
            if (isNaN(n)) return min;
            return Math.max(min, Math.min(max, n));
        },

        // æ¸…ç†æ¨™ç±¤è¼¸å…¥
        sanitizeTags(tagsStr) {
            if (!tagsStr) return [];
            return tagsStr
                .split(',')
                .map(tag => this.escapeHTML(tag.trim()))
                .filter(tag => tag.length > 0 && tag.length < 50)
                .slice(0, 10); // æœ€å¤š 10 å€‹æ¨™ç±¤
        }
    };

    // ==================== æ‡‰ç”¨ç¨‹å¼ä¸»é«” ====================
    const App = {
        // ç•¶å‰ç”¨æˆ¶
        currentUser: 'default',
        
        // æ‰€æœ‰ç”¨æˆ¶è³‡æ–™
        allUserData: {},
        
        // ç•¶å‰ä»»å‹™åˆ—è¡¨
        todos: [],
        
        // é¸ä¸­çš„ä»»å‹™
        selectedTodos: new Set(),
        
        // åˆå§‹åŒ–
        init() {
            this.loadAllUsers();
            this.loadUserData();
            this.updateUserSelect();
            this.loadDarkMode();
            this.setupKeyboardShortcuts();
            this.render();
            this.updateDashboard();
        },

        // ==================== ç”¨æˆ¶ç®¡ç† ====================
        loadAllUsers() {
            try {
                const data = localStorage.getItem('offlineWork_users');
                this.allUserData = data ? JSON.parse(data) : { default: [] };
            } catch (e) {
                this.allUserData = { default: [] };
            }
        },

        saveAllUsers() {
            try {
                localStorage.setItem('offlineWork_users', JSON.stringify(this.allUserData));
            } catch (e) {
                this.showNotification('å„²å­˜å¤±æ•—', 'error');
            }
        },

        loadUserData() {
            this.todos = this.allUserData[this.currentUser] || [];
        },

        saveUserData() {
            this.allUserData[this.currentUser] = this.todos;
            this.saveAllUsers();
        },

        switchUser(username) {
            this.saveUserData();
            this.currentUser = username;
            this.loadUserData();
            this.selectedTodos.clear();
            this.render();
            this.updateDashboard();
            this.updateFilterOptions();
            this.showNotification(`åˆ‡æ›åˆ°ç”¨æˆ¶: ${username}`, 'success');
        },

        addNewUser() {
            const username = prompt('è¼¸å…¥æ–°ç”¨æˆ¶åç¨±:');
            if (!username) return;
            
            const sanitized = Security.escapeHTML(username.trim());
            if (sanitized.length === 0 || sanitized.length > 30) {
                this.showNotification('ç”¨æˆ¶åç¨±é•·åº¦éœ€åœ¨ 1-30 å­—å…ƒ', 'error');
                return;
            }

            if (this.allUserData[sanitized]) {
                this.showNotification('ç”¨æˆ¶å·²å­˜åœ¨', 'error');
                return;
            }

            this.allUserData[sanitized] = [];
            this.saveAllUsers();
            this.updateUserSelect();
            this.switchUser(sanitized);
        },

        updateUserSelect() {
            const select = document.getElementById('userSelect');
            if (!select) return;

            select.innerHTML = '';
            Object.keys(this.allUserData).sort().forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                if (user === this.currentUser) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        },

        // ==================== æ–°å¢ä»»å‹™ ====================
        addTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            if (!title) {
                this.showNotification('è«‹è¼¸å…¥ä»»å‹™æ¨™é¡Œ', 'error');
                return;
            }

            const todo = {
                id: Date.now() + Math.random(),
                title: Security.escapeHTML(title),
                description: Security.escapeHTML(document.getElementById('todoDescription').value.trim()),
                category: Security.escapeHTML(document.getElementById('todoCategory').value.trim()) || 'æœªåˆ†é¡',
                status: document.getElementById('todoStatus').value,
                priority: document.getElementById('todoPriority').value,
                dueDate: Security.validateDate(document.getElementById('todoDueDate').value),
                progress: Security.validateNumber(document.getElementById('todoProgress').value, 0, 100),
                tags: Security.sanitizeTags(document.getElementById('todoTags').value),
                pinned: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            this.todos.unshift(todo);
            this.saveUserData();
            this.clearForm();
            this.render();
            this.updateDashboard();
            this.updateFilterOptions();
            this.showNotification('ä»»å‹™å·²æ–°å¢', 'success');
        },

        clearForm() {
            document.getElementById('todoTitle').value = '';
            document.getElementById('todoDescription').value = '';
            document.getElementById('todoCategory').value = '';
            document.getElementById('todoStatus').value = 'todo';
            document.getElementById('todoPriority').value = 'medium';
            document.getElementById('todoDueDate').value = '';
            document.getElementById('todoProgress').value = '';
            document.getElementById('todoTags').value = '';
        },

        // ==================== é‡˜é¸åŠŸèƒ½ ====================
        togglePin(id) {
            const todo = this.todos.find(t => t.id === id);
            if (todo) {
                todo.pinned = !todo.pinned;
                todo.updatedAt = new Date().toISOString();
                this.saveUserData();
                this.render();
            }
        },

        // ==================== åˆªé™¤ä»»å‹™ ====================
        deleteTodo(id) {
            this.confirmAction('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™ï¼Ÿ', () => {
                this.todos = this.todos.filter(t => t.id !== id);
                this.selectedTodos.delete(id);
                this.saveUserData();
                this.render();
                this.updateDashboard();
                this.showNotification('ä»»å‹™å·²åˆªé™¤', 'success');
            });
        },

        // ==================== æ›´æ–°ä»»å‹™ ====================
        updateTodoStatus(id, status) {
            const todo = this.todos.find(t => t.id === id);
            if (todo) {
                todo.status = status;
                if (status === 'completed') {
                    todo.progress = 100;
                }
                todo.updatedAt = new Date().toISOString();
                this.saveUserData();
                this.render();
                this.updateDashboard();
            }
        },

        // ==================== æ‰¹é‡æ“ä½œ ====================
        toggleSelectAll() {
            const filtered = this.getFilteredTodos();
            if (this.selectedTodos.size === filtered.length) {
                this.selectedTodos.clear();
            } else {
                filtered.forEach(todo => this.selectedTodos.add(todo.id));
            }
            this.render();
        },

        bulkComplete() {
            if (this.selectedTodos.size === 0) {
                this.showNotification('è«‹å…ˆé¸æ“‡ä»»å‹™', 'error');
                return;
            }

            this.todos.forEach(todo => {
                if (this.selectedTodos.has(todo.id)) {
                    todo.status = 'completed';
                    todo.progress = 100;
                    todo.updatedAt = new Date().toISOString();
                }
            });

            this.selectedTodos.clear();
            this.saveUserData();
            this.render();
            this.updateDashboard();
            this.showNotification('æ‰¹é‡å®ŒæˆæˆåŠŸ', 'success');
        },

        bulkDelete() {
            if (this.selectedTodos.size === 0) {
                this.showNotification('è«‹å…ˆé¸æ“‡ä»»å‹™', 'error');
                return;
            }

            this.confirmAction(`ç¢ºå®šè¦åˆªé™¤ ${this.selectedTodos.size} å€‹ä»»å‹™ï¼Ÿ`, () => {
                this.todos = this.todos.filter(t => !this.selectedTodos.has(t.id));
                this.selectedTodos.clear();
                this.saveUserData();
                this.render();
                this.updateDashboard();
                this.showNotification('æ‰¹é‡åˆªé™¤æˆåŠŸ', 'success');
            });
        },

        // ==================== æœå°‹/ç¯©é¸ ====================
        filterTodos() {
            this.render();
        },

        getFilteredTodos() {
            let filtered = [...this.todos];

            // æœå°‹é—œéµå­—
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(todo => 
                    todo.title.toLowerCase().includes(searchTerm) ||
                    todo.description.toLowerCase().includes(searchTerm) ||
                    todo.category.toLowerCase().includes(searchTerm) ||
                    todo.tags.some(tag => tag.toLowerCase().includes(searchTerm))
                );
            }

            // ç‹€æ…‹ç¯©é¸
            const statusFilter = document.getElementById('filterStatus')?.value;
            if (statusFilter && statusFilter !== 'all') {
                filtered = filtered.filter(todo => todo.status === statusFilter);
            }

            // å„ªå…ˆåº¦ç¯©é¸
            const priorityFilter = document.getElementById('filterPriority')?.value;
            if (priorityFilter && priorityFilter !== 'all') {
                filtered = filtered.filter(todo => todo.priority === priorityFilter);
            }

            // åˆ†é¡ç¯©é¸
            const categoryFilter = document.getElementById('filterCategory')?.value;
            if (categoryFilter && categoryFilter !== 'all') {
                filtered = filtered.filter(todo => todo.category === categoryFilter);
            }

            // æ’åº: é‡˜é¸å„ªå…ˆï¼Œç„¶å¾Œä¾å»ºç«‹æ™‚é–“
            filtered.sort((a, b) => {
                if (a.pinned !== b.pinned) return b.pinned ? 1 : -1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            return filtered;
        },

        clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterPriority').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            this.render();
        },

        updateFilterOptions() {
            const categorySelect = document.getElementById('filterCategory');
            if (!categorySelect) return;

            const categories = new Set();
            this.todos.forEach(todo => categories.add(todo.category));

            const currentValue = categorySelect.value;
            categorySelect.innerHTML = '<option value="all">æ‰€æœ‰åˆ†é¡</option>';
            
            Array.from(categories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            if (categories.has(currentValue)) {
                categorySelect.value = currentValue;
            }
        },

        // ==================== æ¸²æŸ“ä»‹é¢ ====================
        render() {
            const list = document.getElementById('todoList');
            if (!list) return;

            const filtered = this.getFilteredTodos();

            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">ç›®å‰æ²’æœ‰ä»»å‹™</div>';
                this.updateSelectedCount();
                return;
            }

            list.innerHTML = filtered.map(todo => this.renderTodoItem(todo)).join('');
            this.updateSelectedCount();
        },

        renderTodoItem(todo) {
            const isSelected = this.selectedTodos.has(todo.id);
            const pinnedClass = todo.pinned ? 'pinned' : '';
            const completedClass = todo.status === 'completed' ? 'completed' : '';
            
            const priorityClass = `priority-${todo.priority}`;
            const statusClass = `status-${todo.status}`;

            const statusText = {
                'todo': 'å¾…è¾¦',
                'in-progress': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ'
            }[todo.status] || todo.status;

            const priorityText = {
                'high': 'é«˜',
                'medium': 'ä¸­',
                'low': 'ä½'
            }[todo.priority] || todo.priority;

            const dueDateHTML = todo.dueDate ? 
                `<div class="meta-item">ğŸ“… ${todo.dueDate}</div>` : '';

            const tagsHTML = todo.tags.length > 0 ?
                todo.tags.map(tag => `<span class="category-tag">${tag}</span>`).join('') : '';

            return `
                <div class="todo-item ${pinnedClass} ${completedClass}">
                    <div class="todo-header">
                        <input 
                            type="checkbox" 
                            class="todo-checkbox" 
                            ${isSelected ? 'checked' : ''}
                            onchange="app.toggleSelect(${todo.id})"
                        />
                        <div class="todo-title">${todo.title}</div>
                        <button 
                            class="pin-btn ${todo.pinned ? 'active' : ''}" 
                            onclick="app.togglePin(${todo.id})"
                            title="${todo.pinned ? 'å–æ¶ˆé‡˜é¸' : 'é‡˜é¸'}"
                        >
                            ${todo.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
                        </button>
                    </div>
                    
                    <div class="todo-meta">
                        <div class="meta-item">
                            <span class="category-tag">${todo.category}</span>
                        </div>
                        <div class="meta-item ${statusClass}">ç‹€æ…‹: ${statusText}</div>
                        <div class="meta-item ${priorityClass}">å„ªå…ˆåº¦: ${priorityText}</div>
                        <div class="meta-item">é€²åº¦: ${todo.progress}%</div>
                        ${dueDateHTML}
                    </div>

                    ${todo.description ? `<div style="margin: 10px 0; color: var(--text-secondary);">${todo.description}</div>` : ''}
                    
                    ${tagsHTML ? `<div style="margin: 10px 0;">${tagsHTML}</div>` : ''}

                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="app.updateTodoStatus(${todo.id}, 'todo')" style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--text-secondary); color: white; cursor: pointer;">å¾…è¾¦</button>
                        <button onclick="app.updateTodoStatus(${todo.id}, 'in-progress')" style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--accent); color: white; cursor: pointer;">é€²è¡Œä¸­</button>
                        <button onclick="app.updateTodoStatus(${todo.id}, 'completed')" style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--success); color: white; cursor: pointer;">å®Œæˆ</button>
                        <button onclick="app.deleteTodo(${todo.id})" style="padding: 6px 12px; border: none; border-radius: 4px; background: var(--danger); color: white; cursor: pointer; margin-left: auto;">åˆªé™¤</button>
                    </div>
                </div>
            `;
        },

        toggleSelect(id) {
            if (this.selectedTodos.has(id)) {
                this.selectedTodos.delete(id);
            } else {
                this.selectedTodos.add(id);
            }
            this.updateSelectedCount();
        },

        updateSelectedCount() {
            const countElem = document.getElementById('selectedCount');
            const selectAllText = document.getElementById('selectAllText');
            
            if (countElem) {
                if (this.selectedTodos.size > 0) {
                    countElem.textContent = `å·²é¸æ“‡ ${this.selectedTodos.size} å€‹`;
                } else {
                    countElem.textContent = '';
                }
            }

            if (selectAllText) {
                const filtered = this.getFilteredTodos();
                selectAllText.textContent = this.selectedTodos.size === filtered.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸';
            }
        },

        // ==================== çµ±è¨ˆå„€è¡¨æ¿ ====================
        updateDashboard() {
            const total = this.todos.length;
            const completed = this.todos.filter(t => t.status === 'completed').length;
            const inProgress = this.todos.filter(t => t.status === 'in-progress').length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('completionRate').textContent = rate + '%';
        },

        // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
        exportData(format) {
            if (this.todos.length === 0) {
                this.showNotification('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'error');
                return;
            }

            let content, filename, type;

            switch (format) {
                case 'json':
                    content = JSON.stringify(this.todos, null, 2);
                    filename = `todos_${this.currentUser}_${this.getTimestamp()}.json`;
                    type = 'application/json';
                    break;

                case 'csv':
                    content = this.toCSV(this.todos);
                    filename = `todos_${this.currentUser}_${this.getTimestamp()}.csv`;
                    type = 'text/csv';
                    break;

                case 'excel':
                    this.exportExcel(this.todos, `todos_${this.currentUser}_${this.getTimestamp()}.xlsx`);
                    return;

                case 'markdown':
                    content = this.toMarkdown(this.todos);
                    filename = `todos_${this.currentUser}_${this.getTimestamp()}.md`;
                    type = 'text/markdown';
                    break;
            }

            this.downloadFile(content, filename, type);
            this.showNotification('åŒ¯å‡ºæˆåŠŸ', 'success');
        },

        exportAllUsers() {
            const allData = {};
            Object.keys(this.allUserData).forEach(user => {
                allData[user] = {
                    todos: this.allUserData[user],
                    stats: {
                        total: this.allUserData[user].length,
                        completed: this.allUserData[user].filter(t => t.status === 'completed').length
                    }
                };
            });

            const content = JSON.stringify(allData, null, 2);
            const filename = `all_users_${this.getTimestamp()}.json`;
            this.downloadFile(content, filename, 'application/json');
            this.showNotification('ç¸½è¦½åŒ¯å‡ºæˆåŠŸ', 'success');
        },

        toCSV(todos) {
            const headers = ['æ¨™é¡Œ', 'æè¿°', 'åˆ†é¡', 'ç‹€æ…‹', 'å„ªå…ˆåº¦', 'é€²åº¦', 'æˆªæ­¢æ—¥æœŸ', 'æ¨™ç±¤', 'å»ºç«‹æ™‚é–“'];
            const rows = todos.map(todo => [
                todo.title,
                todo.description,
                todo.category,
                todo.status,
                todo.priority,
                todo.progress,
                todo.dueDate || '',
                todo.tags.join(';'),
                todo.createdAt
            ]);

            return [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        },

        toMarkdown(todos) {
            let md = `# ä»»å‹™æ¸…å–® - ${this.currentUser}\n\n`;
            md += `åŒ¯å‡ºæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n\n`;
            
            const groups = {};
            todos.forEach(todo => {
                if (!groups[todo.category]) groups[todo.category] = [];
                groups[todo.category].push(todo);
            });

            Object.keys(groups).sort().forEach(category => {
                md += `## ${category}\n\n`;
                groups[category].forEach(todo => {
                    const checkbox = todo.status === 'completed' ? '[x]' : '[ ]';
                    md += `- ${checkbox} **${todo.title}**\n`;
                    if (todo.description) md += `  - ${todo.description}\n`;
                    md += `  - å„ªå…ˆåº¦: ${todo.priority} | é€²åº¦: ${todo.progress}%\n`;
                    if (todo.dueDate) md += `  - æˆªæ­¢: ${todo.dueDate}\n`;
                    md += `\n`;
                });
                md += `\n`;
            });

            return md;
        },

        exportExcel(todos, filename) {
            // ä½¿ç”¨ SheetJS (å·²åœ¨ HTML ä¸­å¼•å…¥)
            if (typeof XLSX === 'undefined') {
                this.showNotification('Excel åŠŸèƒ½æœªè¼‰å…¥', 'error');
                return;
            }

            const data = todos.map(todo => ({
                'æ¨™é¡Œ': todo.title,
                'æè¿°': todo.description,
                'åˆ†é¡': todo.category,
                'ç‹€æ…‹': todo.status,
                'å„ªå…ˆåº¦': todo.priority,
                'é€²åº¦': todo.progress,
                'æˆªæ­¢æ—¥æœŸ': todo.dueDate || '',
                'æ¨™ç±¤': todo.tags.join(', '),
                'å»ºç«‹æ™‚é–“': new Date(todo.createdAt).toLocaleString('zh-TW')
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
            XLSX.writeFile(wb, filename);
        },

        // ==================== åŒ¯å…¥åŠŸèƒ½ ====================
        importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!Array.isArray(imported)) {
                        this.showNotification('æ ¼å¼éŒ¯èª¤', 'error');
                        return;
                    }

                    // æ¸…ç†ä¸¦é©—è­‰æ¯å€‹ä»»å‹™
                    const cleaned = imported.map(todo => ({
                        id: Date.now() + Math.random(),
                        title: Security.escapeHTML(todo.title || 'æœªå‘½å'),
                        description: Security.escapeHTML(todo.description || ''),
                        category: Security.escapeHTML(todo.category || 'æœªåˆ†é¡'),
                        status: ['todo', 'in-progress', 'completed'].includes(todo.status) ? todo.status : 'todo',
                        priority: ['high', 'medium', 'low'].includes(todo.priority) ? todo.priority : 'medium',
                        dueDate: Security.validateDate(todo.dueDate),
                        progress: Security.validateNumber(todo.progress, 0, 100),
                        tags: Security.sanitizeTags(todo.tags ? todo.tags.join(',') : ''),
                        pinned: false,
                        createdAt: todo.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }));

                    this.todos = [...cleaned, ...this.todos];
                    this.saveUserData();
                    this.render();
                    this.updateDashboard();
                    this.updateFilterOptions();
                    this.showNotification(`æˆåŠŸåŒ¯å…¥ ${cleaned.length} å€‹ä»»å‹™`, 'success');
                } catch (err) {
                    this.showNotification('åŒ¯å…¥å¤±æ•—', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        },

        // ==================== æ·±è‰²æ¨¡å¼ ====================
        toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDark);
        },

        loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        },

        // ==================== éµç›¤å¿«æ·éµ ====================
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+F: èšç„¦æœå°‹
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }

                // Ctrl+N: èšç„¦æ–°å¢
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('todoTitle').focus();
                }

                // ESC: æ¸…é™¤é¸æ“‡
                if (e.key === 'Escape') {
                    this.selectedTodos.clear();
                    this.render();
                }
            });
        },

        // ==================== å·¥å…·å‡½æ•¸ ====================
        getTimestamp() {
            return new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        },

        downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        },

        showNotification(message, type = 'info') {
            // ç°¡å–®é€šçŸ¥ï¼ˆä¸ç”¨ console.logï¼‰
            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                info: '#4a90e2'
            };

            const notif = document.createElement('div');
            notif.textContent = message;
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${colors[type]};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;

            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        },

        confirmAction(message, callback) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.onclick = () => {
                overlay.remove();
                dialog.remove();
            };

            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 10px;">${message}</div>
                <div class="confirm-buttons">
                    <button class="btn-confirm-yes">ç¢ºå®š</button>
                    <button class="btn-confirm-no">å–æ¶ˆ</button>
                </div>
            `;

            dialog.querySelector('.btn-confirm-yes').onclick = () => {
                callback();
                overlay.remove();
                dialog.remove();
            };

            dialog.querySelector('.btn-confirm-no').onclick = () => {
                overlay.remove();
                dialog.remove();
            };

            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
        }
    };

    // ==================== å…¨åŸŸæš´éœ² ====================
    window.app = App;

    // ==================== å•Ÿå‹•æ‡‰ç”¨ ====================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => App.init());
    } else {
        App.init();
    }

})();

    </script>
</body>
</html>
